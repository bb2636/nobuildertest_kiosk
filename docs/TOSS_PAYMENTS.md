# 토스페이먼츠 연동 가이드

## 현재 구현

- 결제 수단: **카드 결제**, **토스 포인트**, 현금, 모바일, 기타.
- **카드 / 토스 포인트 선택 시**: 주문을 `PENDING` 으로 생성한 뒤 **토스 결제창**을 띄웁니다. 사용자가 토스 창에서 결제를 완료해야만 성공 URL(`/payment/success`) 로 리다이렉트되고, 해당 페이지에서 백엔드 `POST /api/payments/confirm` 으로 승인합니다. **승인 API가 성공한 경우에만** 주문을 `PAID` 로 변경·포인트 10% 적립 후 주문 완료 페이지로 이동합니다. (결제창에서 취소 시 `failUrl`(/checkout) 로 돌아옴.)
- **현금 / 모바일 / 기타**: 결제창 없이 주문 생성 시 바로 `PAID` + 포인트 적립 후 주문 완료 페이지로 이동합니다.
- **전액 포인트(결제 0원)**: 카드/토스 선택 상태에서도 토스 결제창을 띄우지 않고 즉시 `PAID` 처리 후 주문 완료로 이동합니다.
- **포인트 사용 상한**: 사용 포인트 합계가 주문 금액을 초과할 수 없어, 결제 금액이 0원 미만으로 내려가지 않습니다.
- **결제 취소**: **관리자**에서 주문 상태를 "취소"로 변경할 때, 또는 **유저**가 마이페이지·주문 상태 보기에서 "주문 취소"를 요청할 때, 해당 주문이 토스로 결제된 경우 **토스 결제 취소 API**를 먼저 호출합니다. 취소 성공 시에만 주문을 CANCELED로 변경하고 **paymentStatus를 REFUNDED로 갱신**한 뒤 적립 포인트를 회수합니다. 유저 취소는 **접수대기(WAITING) 상태일 때만** 가능하며, 제조중·픽업대기·완료 등 그 외 상태에서는 취소 불가. 토스 취소 실패 시 400과 메시지를 반환합니다.
- 개발·테스트 시 토스페이먼츠 **테스트 키**(`test_ck_...`, `test_sk_...`) 를 사용하면 결제창에서 테스트 카드로 결제할 수 있습니다.

## 실제 토스 결제 연동 절차

### 1. 토스페이먼츠 가입 및 키 발급

- [토스페이먼츠 개발자센터](https://docs.tosspayments.com/) 에서 가입 후 **클라이언트 키**, **시크릿 키** 발급
- 테스트용 키로 먼저 연동 후, 운영 시 라이브 키로 교체

### 2. 환경 변수

- **프론트** (`.env`): `VITE_TOSSPAYMENTS_CLIENT_KEY` — 결제창 호출 시 사용 (Vite 가 `import.meta.env.VITE_*` 로만 노출)
- **백엔드** (`.env`): `TOSSPAYMENTS_SECRET_KEY` — 결제 승인 API 호출 시 사용 (노출 금지)
- `.env.example` 에 변수 이름이 정리되어 있음

### 3. SDK 로드 (결제 화면)

```html
<!-- index.html 또는 결제 페이지에서 -->
<script src="https://js.tosspayments.com/v2/payment"></script>
```

또는 npm:

```bash
npm install @tosspayments/payment-sdk
```

### 4. 결제 요청 흐름

1. **결제하기** 클릭 시  
   - 주문 생성 전에 `orderId`(우리 주문 ID), `amount`, `customerKey`(구매자 식별자) 로 토스 결제창/위젯 호출
2. 사용자가 토스 결제창에서 **토스 포인트** 등으로 결제 완료
3. 토스가 리다이렉트 또는 콜백으로 `paymentKey`, `orderId` 등 전달
4. **백엔드** 에서 시크릿 키로 토스 **결제 승인 API** 호출
5. 승인 성공 후 우리 DB에 주문 저장 + 포인트 10% 적립

### 5. 백엔드 결제 승인 (예시)

- `POST https://api.tosspayments.com/v1/payments/confirm`  
  - Body: `paymentKey`, `orderId`, `amount`
  - Header: `Authorization: Basic <시크릿키 Base64>`
- 성공 시 우리 서버에서 주문 생성 + `userId` 있으면 포인트 적립

### 6. 포인트 적립 (가게)

- 이미 구현됨: 주문 생성 시 `userId` 가 있으면 **결제 금액의 10%** 를 `User.point` 에 적립
- 토스 연동 후에는 “토스 결제 승인 성공” 시점에 같은 로직으로 주문 생성하면 됨

## 트러블슈팅

### `Failed to launch 'supertoss://pay?payToken=...' because the scheme does not have a registered handler`

- **원인**: `supertoss://` 는 **토스 앱 전용 딥링크** 스킴입니다. PC 브라우저나 토스 앱이 설치되지 않은 환경에서는 이 스킴을 처리할 핸들러가 없습니다.
- **대응**: 
  - 실제 결제는 **모바일에서 토스 앱이 설치된 경우**에만 `supertoss://` 로 앱이 열립니다.
  - PC 또는 앱 미설치 환경에서는 토스 결제창 내 **카드/계좌이체 등 웹 결제**로 진행하거나, 테스트 시 토스페이먼츠 **테스트 카드**를 사용하면 됩니다.

### 토스뱅크를 선택했는데 하나카드가 뜨는 경우

- 결제창에서 "토스뱅크"를 눌렀을 때 **하나카드** 등 다른 카드사/결제수단이 노출되는 것은 **토스페이먼츠 결제창(또는 SDK) 쪽 UI/기본 결제수단 설정**에 따른 동작일 수 있습니다.
- 토스페이먼츠 **개발자센터·대시보드**에서 결제 수단별 노출 순서, 기본 선택 카드 등 설정을 확인해 보시고, 필요 시 [토스페이먼츠 고객센터/문의](https://www.tosspayments.com/)에 문의하는 것을 권장합니다.

### 기타 스킴/리소스 오류 (결제창·앱 딥링크)

- **`Failed to launch 'itms-appss://...'`**: 앱스토어 앱 설치 링크 스킴. PC 브라우저에는 핸들러가 없어 무시해도 됩니다.
- **`Failed to launch 'nhallonepayansimclick://...'`** (NH 등): 해당 뱅크/카드사 앱 전용 딥링크. 해당 앱이 없는 환경에서는 정상적으로 실패할 수 있습니다.
- **`GET .../hanacard.co.kr/.../favicon.ico 404`**: 결제창 iframe/리소스 요청으로, 404는 동작에 영향 없을 수 있습니다.

### 카카오페이 등 결제 시 `POST /api/payments/confirm` 400 (Bad Request)

- **흐름**: 결제 성공 후 토스가 `successUrl`로 리다이렉트할 때 `paymentKey`, `orderId`, `amount`를 쿼리로 넘깁니다. 프론트에서 이 값으로 `POST /api/payments/confirm`을 호출하고, 우리 서버가 토스 승인 API를 한 번 더 호출해 확정합니다.
- **400이 나는 경우**:
  1. **파라미터 부족/오류**: URL에 `paymentKey`, `orderId`, `amount`가 없거나 형식이 잘못된 경우. (리다이렉트 URL이 잘못되었거나, 일부 환경에서 쿼리가 누락될 수 있음.)
  2. **토스 승인 API 실패**: 우리 서버가 토스에 승인 요청을 보냈을 때 토스가 4xx를 반환한 경우. **카카오페이** 등 일부 수단은 **테스트/개발 환경에서 제한**되거나, “이미 승인된 결제” 등 사유로 실패할 수 있습니다.
  3. **금액 불일치**: 결제 금액과 주문 금액이 다를 때 (`amount_mismatch`).
- **대응**:
  - 결제 실패 화면에 표시되는 **에러 메시지**를 확인하세요. 서버가 토스에서 내려준 메시지를 그대로 넘기도록 되어 있습니다.
  - **테스트** 시에는 토스페이먼츠 **테스트 카드** 사용을 권장합니다. 카카오페이는 실제 계정/환경에서만 동작할 수 있습니다.
  - 같은 결제를 두 번 승인하면 “이미 처리된 결제” 등으로 400이 날 수 있으므로, 새 주문으로 다시 결제해 보세요.

### 결제 완료 후 성공 페이지가 안 보일 때

- **현금 결제** 후에는 토스 리다이렉트 없이 바로 `/order-done?orderNo=...` 로 이동합니다. 주문 완료 모달이 `z-[100]` 으로 최상단에 표시되도록 되어 있습니다.
- **`GET /api/user/me 401`**: 로그인하지 않은 상태에서 다른 화면(예: 마이페이지 진입)이 `/api/user/me` 를 호출하면 401이 날 수 있습니다. **주문 완료 페이지(`/order-done`)는 로그인 없이 표시**되며, 401은 주문 완료 화면 표시와 무관합니다.

## 참고

- [토스페이먼츠 결제창 연동](https://docs.tosspayments.com/guides/payment/integration)
- [JavaScript SDK v2](https://docs.tosspayments.com/sdk/v2/js)
