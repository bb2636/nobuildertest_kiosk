# 결제 로직 점검 및 테스트 가이드

## 1. 결제 흐름 요약

| 구분 | 카드/토스 포인트 | 현금/모바일/기타 | 전액 포인트(0원 결제) |
|------|------------------|------------------|------------------------|
| 주문 생성 | `PENDING` + 주문 생성 후 토스 결제창 | `PAID` + 주문 생성 | `PAID` + 주문 생성 (토스 창 없음) |
| 결제 완료 | 토스 리다이렉트 → `POST /api/payments/confirm` → PAID + 포인트 적립 | 즉시 완료 | 즉시 완료 |
| 취소 시 | 토스 취소 API 호출 후 `status=CANCELED`, `paymentStatus=REFUNDED` | 동일 | 동일 |

## 2. 구현된 보호 로직

- **결제 금액 0원 미만 방지**
  - 포인트 사용 합계가 주문 금액을 넘지 않도록 UI에서 제한 (`useStorePoint + useTossPoint <= totalPrice`).
  - `totalPrice` 변경 시 기존 포인트 선택 자동 보정.
  - 주문 요청 시 `usePoint = Math.min(useStorePoint, totalPrice)` 로 한 번 더 캡.
- **전액 포인트(결제 0원)**
  - 카드/토스 선택 상태에서도 토스 결제창을 띄우지 않고, 즉시 PAID 처리 후 주문 완료 페이지로 이동.
- **취소 시 결제 쪽 동기화**
  - 관리자/유저 주문 취소 시 `paymentStatus`를 `REFUNDED`로 갱신해 결제 화면에서도 환불 상태로 표시.
- **ORDER_TOTAL_MISMATCH**
  - 서버: 클라이언트 합계와 1원 이내 오차 허용, 저장 금액은 서버 계산값(`computedTotal`) 기준.
  - 클라이언트: 해당 에러 시 "주문 금액이 일치하지 않습니다. 장바구니를 확인한 뒤 다시 시도해 주세요." 안내.

## 3. 수동 테스트 체크리스트

실행: `npm run dev` 후 키오스크 `http://localhost:5173/` 에서 진행.

### 3.1 기본 결제

- [ ] 메뉴 담기 → 장바구니 → 결제하기 진입
- [ ] **현금** 선택 → 결제하기 → 주문 완료 페이지 이동, 마이페이지 주문내역에 주문 노출
- [ ] **카드** 선택 시 (토스 키 설정된 경우) 토스 결제창 로드 후 테스트 카드로 결제 → 성공 URL → 주문 완료
- [ ] 토스 키 미설정 시 "토스 테스트 결제 키가 없습니다" 메시지 표시

### 3.2 포인트 사용

- [ ] 로그인 후 보유 포인트 있는 계정으로 결제 화면 진입
- [ ] 매장 포인트 "전액 사용" 시 사용액이 주문 금액을 넘지 않음
- [ ] 사용 포인트 + 토스 포인트 합이 주문 금액 초과되지 않음 (버튼 선택 시 자동 상한)
- [ ] 결제 금액이 0원이면 "0원 결제하기" 버튼으로 표시되고, 클릭 시 토스 창 없이 즉시 주문 완료

### 3.3 취소 및 환불

- [ ] 토스로 결제한 주문을 관리자에서 "취소"로 변경 → 주문 상태 취소, 결제 상태 환불로 표시
- [ ] 접수대기 주문을 유저가 "주문 취소" → 동일하게 취소·환불 반영
- [ ] 취소 후 마이페이지 포인트: 해당 주문으로 적립된 포인트 회수됨
- [ ] 결제/관리자 쪽에서 해당 주문이 "환불"로 보이는지 확인

### 3.4 에러 케이스

- [ ] 보유 포인트보다 많이 사용하려 할 때 "보유 포인트가 부족합니다" 표시
- [ ] (옵션 가격 차이로) ORDER_TOTAL_MISMATCH 발생 시 위 안내 문구 표시
- [ ] 토스 스크립트 로드 실패 시 재시도 후 "네트워크를 확인하거나 광고 차단을 해제한 후..." 안내

## 4. 관련 파일

| 역할 | 경로 |
|------|------|
| 결제 화면(포인트 상한, 토스 호출, 0원 처리) | `client/src/pages/kiosk/Checkout.tsx` |
| 결제 성공(승인 API 호출) | `client/src/pages/kiosk/PaymentSuccess.tsx` |
| 주문 생성 API | `server/routes/orders.ts`, `server/services/orderService.ts` |
| 주문 저장/검증 | `server/repositories/orderRepository.ts` |
| 토스 승인 | `server/routes/payments.ts` |
| 토스 취소 | `server/services/tossCancel.ts` |
| 취소 시 주문·결제 상태 갱신 | `server/routes/admin.ts`, `server/routes/user.ts` |

## 5. 환경 변수

- `VITE_TOSSPAYMENTS_CLIENT_KEY`: 토스 결제창 (테스트: `test_ck_...`)
- `TOSSPAYMENTS_SECRET_KEY`: 토스 승인/취소 API (테스트: `test_sk_...`)

`.env`는 프로젝트 루트(step4)에 두고, 수정 후 클라이언트·서버를 재시작해야 반영됩니다.
