# 결제·주문 플로우 점검 및 테스트 시나리오

## 1. 전체 로직 순서 (결제까지)

| 순서 | 화면/동작 | 설명 |
|------|-----------|------|
| 1 | 키오스크 홈 | 카테고리·메뉴 그리드, 장바구니 수량·총액 |
| 2 | 메뉴 상세 | 옵션·수량 선택 후 "메뉴 담기" → 장바구니 추가 |
| 3 | 장바구니 | 수량 변경·삭제, "결제하기" → 결제 화면 이동 |
| 4 | 결제(Checkout) | 식사 방법(매장/포장) → 포인트 사용(선택) → 결제수단 선택 → "N원 결제하기" |
| 5a | **카드/토스** + 결제금액 > 0 | ① 주문 생성(PENDING) ② 토스 결제창 오픈 ③ 사용자 결제 → successUrl 리다이렉트 |
| 5b | **현금/모바일/기타** 또는 전액 포인트 | ① 주문 생성(PAID) ② 곧바로 주문 완료 페이지로 이동 |
| 6 | PaymentSuccess (토스 성공 시만) | paymentKey·orderId·amount로 `/api/payments/confirm` 호출 → PAID 처리·포인트 적립 → 주문 완료 페이지 이동 |
| 7 | OrderDone | 주문번호·픽업 안내, 장바구니 비움 |

---

## 2. 결제 방식별 동작 요약

**현재 노출 결제수단**: **토스 결제** + **현금**만 (카드/모바일/기타는 UI에서 제거됨).

| 결제수단 | 결제창 | 주문 생성 시 paymentStatus | 포인트 적립 시점 |
|----------|--------|----------------------------|------------------|
| **토스 결제** | 토스 SDK (리다이렉트) | PENDING | `/payments/confirm` 성공 시에만 |
| **현금** | 없음 | PAID | 주문 생성 시(createOrderWithItems 내) |
| **전액 포인트**(결제 0원) | 없음 | PAID | 0원이므로 적립 0 |

- **토스 선택 시**: 주문은 먼저 PENDING으로 생성되고, **결제창이 실제로 열려서 결제가 완료된 뒤** successUrl → confirm API가 호출되어야만 PAID·포인트 적립이 됨.
- 결제창이 **한 번도 안 뜨거나**, 사용자가 **취소/닫기**하면 주문은 **PENDING으로만 남고** 포인트는 적립되지 않음.

---

## 3. “결제 안 했는데 성공한 것처럼 보였다” 가능 원인

- **비회원 주문**  
  - 카드/토스로 주문만 생성(PENDING)되고 결제창이 안 떴거나 취소된 경우, 주문은 DB에 있지만 **userId가 null**이라 **마이페이지 주문내역에는 안 나옴**.  
  - “주문내역에 보이지 않았다”가 이 경우일 수 있음.
- **포인트 적립**  
  - PENDING 주문에는 서버에서 포인트를 넣지 않음.  
  - “포인트가 적립됐다”고 느낀 경우:  
    - 결제 화면의 **“포인트 적립 10%” 미리보기**를 실제 적립으로 오인했거나,  
    - **다른 결제(현금 등)**로 완료된 주문의 적립을 보신 경우를 점검하는 것이 좋음.
- **토스 결제창 실패 후**  
  - 이전에는 createOrder 성공 후 `requestPayment`가 throw되어도 메시지만 없이 멈춰, “결제가 된 것 같다”고 느낄 수 있었음.  
  - 지금은 **결제창을 열 수 없으면**  
    - “주문번호 OOO는 미결제 상태로 접수되었습니다. 매장에서 현금 결제하시거나, 마이페이지에서 해당 주문을 확인해 주세요.”  
    로 안내하도록 수정되어 있음.

---

## 4. 결제 테스트 시나리오 (다양하게)

### 4.1 사전 확인
- [ ] 백엔드 실행 중 (예: `npm run dev` → 3001 포트)
- [ ] `.env`에 `VITE_TOSSPAYMENTS_CLIENT_KEY`, `TOSSPAYMENTS_SECRET_KEY` (테스트 키) 설정
- [ ] 브라우저에서 `https://js.tosspayments.com/v2/payment` 로드 가능 (광고 차단 해제)

### 4.2 현금/모바일/기타 (결제창 없음)
| 시나리오 | 조작 | 기대 결과 |
|----------|------|-----------|
| 현금 결제 | 결제수단 "현금" → 결제하기 | 결제창 없이 바로 주문 완료 페이지, 주문내역에 PAID로 표시, 포인트 적립(로그인 시) |
| 전액 포인트 | 포인트만 사용해 결제금액 0원 → 카드/토스 선택 상태로 결제하기 | 결제창 없이 주문 완료, 적립 0 |
| 모바일/기타 | 결제수단 "모바일" 또는 "기타" → 결제하기 | 위와 동일 (결제창 없이 완료) |

### 4.3 카드/토스 (토스 결제창)
| 시나리오 | 조작 | 기대 결과 |
|----------|------|-----------|
| 결제 완료 | 카드/토스 선택 → 결제하기 → 토스 창에서 결제 완료 | successUrl 이동 → confirm 호출 → 주문 완료 페이지, PAID·포인트 적립 |
| 결제 취소 | 토스 창에서 "취소" 또는 닫기 | failUrl로 복귀 → "결제가 취소되었습니다. 장바구니는 유지됩니다" 배너, 주문은 PENDING 유지, 포인트 미적립 |
| 결제창 미오픈 | 결제하기 클릭 후 스크립트/네트워크 오류 등으로 창이 안 뜸 | "결제창을 열 수 없었습니다. 주문번호 OOO는 미결제 상태로..." 메시지, 장바구니 유지 |
| 주문 API 실패 | 서버 중지 등으로 createOrder 실패 | "주문 접수에 실패했습니다" 또는 서버 에러 메시지, 토스 창은 열리지 않음 |

### 4.4 포인트 사용
| 시나리오 | 조작 | 기대 결과 |
|----------|------|-----------|
| 일부 포인트 사용 + 카드 | 포인트 사용 후 카드 결제 | 토스 결제창에는 (총액 - 포인트)만 표시, 결제 완료 시 해당 금액 기준 포인트 적립 |
| 전액 포인트 | 포인트로 전액 차감 | 결제창 없이 주문 완료, 적립 0 |

### 4.5 비회원 vs 회원
| 시나리오 | 기대 결과 |
|----------|-----------|
| 비회원 + 현금/기타 | 주문 생성(PAID), 주문 완료 페이지, 마이페이지 주문목록에는 안 나옴 (비회원은 주문번호로만 조회) |
| 비회원 + 카드 | 주문 생성(PENDING) → 토스 결제 → confirm 후 PAID. 비회원이므로 주문내역 목록에는 없고, orderId 알면 단건 조회 가능 |
| 회원 + 카드 결제 완료 | 주문 PAID, 마이페이지 주문내역에 표시, 포인트 적립 |

---

## 5. 점검 체크리스트 (실제 테스트 시)

1. **현금 결제**  
   - [ ] 결제하기 → 주문 완료 페이지로 바로 이동  
   - [ ] 주문번호·픽업 안내 노출  
   - [ ] 로그인 시 포인트 적립  
   - [ ] 마이페이지(회원) 또는 주문번호 조회(비회원)에서 주문 확인  

2. **카드/토스 – 정상**  
   - [ ] 결제하기 클릭 시 **토스 결제창(리다이렉트/팝업)이 반드시 열림**  
   - [ ] 결제 완료 시 successUrl → "결제 확인 중…" → 주문 완료 페이지  
   - [ ] 주문 상태 PAID, 포인트 적립  
   - [ ] 장바구니 비워짐  

3. **카드/토스 – 취소**  
   - [ ] 토스 창에서 취소/닫기 → failUrl 복귀  
   - [ ] "결제가 취소되었습니다. 장바구니는 유지됩니다" 표시  
   - [ ] 해당 주문은 PENDING, 포인트 미적립  

4. **카드/토스 – 결제창 미오픈**  
   - [ ] 네트워크/스크립트 오류 등으로 창이 안 열리면  
   - [ ] "결제창을 열 수 없었습니다. 주문번호 OOO는 미결제 상태로 접수되었습니다..." 메시지  
   - [ ] 장바구니 유지, 해당 주문은 DB에서 PENDING  

5. **API/서버 오류**  
   - [ ] 서버 중지 후 결제 시도 → 네트워크 오류 또는 "주문 접수에 실패했습니다" 등  
   - [ ] 토스 결제창은 열리지 않음  

---

## 6. 코드상 정리 (참고)

- **토스 플로우**: `Checkout.tsx`에서  
  - `createOrder` 호출 → 성공 시 `res.orderId`, `res.orderNo` 확보  
  - `requestPayment(...)` 호출  
  - `requestPayment`가 **throw**되면 (창 미오픈, 사용자 취소 등)  
    - "결제창을 열 수 없었습니다. 주문번호 OOO는 미결제 상태로 접수되었습니다..." 로 안내하고,  
    - 장바구니는 그대로 두며, 해당 주문만 PENDING으로 남김.  
- **포인트 적립**:  
  - 서버 `orderRepository`에서 `paymentStatus === 'PAID'`일 때만 적립.  
  - 토스는 `/payments/confirm` 성공 시에만 PAID로 바꾸고 포인트 적립.

이 문서와 체크리스트로 전체 로직 순서와 결제 방식을 꼼꼼히 테스트하면, “결제창이 안 떴는데 성공한 것처럼 보이는” 현상 원인을 구분하고 재현·검증하기 쉬워집니다.
