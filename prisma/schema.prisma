// =============================================================================
// 커피 키오스크 풀스택 DB 스키마 (Neon PostgreSQL + Prisma)
// - 키오스크(모바일) / 백오피스(웹) 공통
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== 카테고리 & 상품 ==========

model Category {
  id        String    @id @default(cuid())
  name      String    // 커피, 티, 논커피, 디저트 등
  isActive  Boolean   @default(true)
  sortOrder Int       @default(0)
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([isActive])
}

model Product {
  id          String    @id @default(cuid())
  categoryId  String
  category    Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  name        String    // 상품명 (한글)
  englishName String?   // 영문명
  description String?  // 상품 설명
  basePrice   Int       // 기본 가격 (원)
  imageUrl    String?   // 대표 이미지 URL
  ingredients String?   // 원재료 (젤라또·디저트 등)
  calories    String?   // 영양정보 JSON: { kcal, carb, sugar, protein, fat, saturatedFat, sodium }
  isAvailable Boolean  @default(true) // 품절 여부 (백오피스에서 관리)
  sortOrder       Int       @default(0)
  isBest          Boolean  @default(false)
  defaultShotCount Int?    // 커피 등: 기본 샷 수 (표시 시 2, 2+1, 2+n)

  productOptions ProductOption[]
  orderItems     OrderItem[]
  cartItems      CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([isAvailable])
}

// ========== 옵션 & 커스터마이징 (상품-옵션 다대다) ==========

model OptionGroup {
  id        String   @id @default(cuid())
  name      String   // 온도 선택, 원두 선택, 사이즈업, 샷 추가 등
  sortOrder Int      @default(0)
  options   Option[]

  @@index([sortOrder])
}

model Option {
  id             String   @id @default(cuid())
  optionGroupId  String
  optionGroup    OptionGroup @relation(fields: [optionGroupId], references: [id], onDelete: Cascade)
  name           String   // HOT, ICE, 레귤러, 라지, +1샷 등
  defaultExtraPrice Int    @default(0) // 기본 추가 금액 (원)
  sortOrder      Int      @default(0)

  productOptions   ProductOption[]
  orderItemOptions  OrderItemOption[]

  @@index([optionGroupId])
}

// Product ↔ Option 다대다: 어떤 상품에 어떤 옵션이 적용되는지 + 상품별 추가금 오버라이드
model ProductOption {
  id         String  @id @default(cuid())
  productId  String
  product    Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  optionId   String
  option     Option  @relation(fields: [optionId], references: [id], onDelete: Cascade)
  extraPrice Int?    // 상품별 추가 금액 (null이면 Option.defaultExtraPrice 사용)

  @@unique([productId, optionId])
  @@index([productId])
  @@index([optionId])
}

// ========== 사용자 ==========

enum UserRole {
  USER
  ADMIN
}

model User {
  id        String   @id @default(cuid())
  name      String   // 성함
  username  String   @unique // 아이디
  email     String   // 메일 주소
  password  String   // 비밀번호 (hashed)
  role      UserRole @default(USER) // USER | ADMIN (관리자 백오피스)
  point     Int      @default(0) // 포인트
  mileage   Int      @default(0) // 마일리지

  // 앱 내 설정
  notificationEnabled Boolean @default(true)  // 알림 여부
  marketingConsent    Boolean @default(false) // 마케팅 수신 동의

  orders    Order[]
  cart      Cart?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([username])
  @@index([email])
  @@index([role])
}

// 약관/개인정보처리방침 (관리자에서 텍스트 관리)
model SiteContent {
  id        String   @id @default(cuid())
  key       String   @unique // "terms" | "privacy"
  content   String   @db.Text // 본문 텍스트
  updatedAt DateTime @updatedAt
}

// 장바구니 (사용자당 1개)
model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model CartItem {
  id         String   @id @default(cuid())
  cartId     String
  cart       Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity   Int      @default(1)
  optionIds  String?   // 선택 옵션 ID 배열 JSON, 예: ["opt1","opt2"]

  createdAt  DateTime @default(now())

  @@index([cartId])
  @@index([productId])
}

// ========== 주문 & 주문항목 (선택 옵션 역추적 가능) ==========

enum OrderType {
  DINE_IN  // 매장
  TAKE_OUT // 포장
}

enum PaymentMethod {
  CARD
  CASH
  MOBILE
  ETC
}

enum PaymentStatus {
  PENDING  // 미결제
  PAID     // 결제완료
  REFUNDED // 환불
  FAILED   // 결제실패
}

enum OrderStatus {
  WAITING     // 접수대기
  PREPARING   // 제조중
  PICKUP_READY // 픽업대기
  COMPLETED   // 완료
  CANCELED    // 취소
}

model Order {
  id            String        @id @default(cuid())
  orderNo       String        @unique // 주문번호 (표시용, 예: 20250205-001)
  orderNumber   Int?          // 순번 (당일 또는 전역)
  userId        String?       // 주문한 사용자 (비회원 주문은 null)
  user          User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  orderType     OrderType     @default(DINE_IN)
  paymentMethod PaymentMethod?
  paymentStatus PaymentStatus @default(PENDING)
  status        OrderStatus   @default(WAITING)
  totalAmount   Int           // 총 주문 금액 (원)

  items OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([updatedAt])
}

model OrderItem {
  id              String   @id @default(cuid())
  orderId         String
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  quantity        Int      @default(1)
  lineTotalAmount Int      // 해당 라인 최종 합계 금액 (옵션 추가금 반영)

  selectedOptions OrderItemOption[]

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

// 주문 항목별 "선택된 옵션" — 어떤 상품의 어떤 옵션이 선택되었는지 역추적
model OrderItemOption {
  id          String    @id @default(cuid())
  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  optionId    String
  option      Option    @relation(fields: [optionId], references: [id])

  @@index([orderItemId])
  @@index([optionId])
}
